<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Spotify Local Files | Deepburn</title>
  <link rel="icon" type="image/png" href="logo.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- NEW: Libraries for color extraction and audio control -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vibrant.js/1.0.0/Vibrant.min.js"></script>
  <script src="./browser-id3-writer.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f1116; --panel:#121418; --panel-2:#0b0d10; --muted:#a8b0bb;
      --text:#e8ebef; --accent:#5a60d1; --accent-2:#6e74e3; --border:#2a2f3d;
      --chip:#22262e; --danger:#e34d4d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(rgba(11, 13, 16, 0.8), rgba(11, 13, 16, 0.8)), url(bg.png);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      overflow: hidden;
    }
    .app{
      display:grid; grid-template-columns:260px 1fr 420px; grid-template-rows:64px 1fr;
      grid-template-areas:"sidebar topbar preview" "sidebar main   preview";
      min-height:100vh; gap:16px; padding:16px;
    }
    /* --- NEW: Upgraded "Liquid Glass" effect for panels --- */
    .sidebar, .topbar, .main, .preview {
      background: rgba(18, 20, 24, 0.65);
      backdrop-filter: blur(16px) saturate(120%);
      -webkit-backdrop-filter: blur(16px) saturate(120%);
      border: 1px solid var(--border);
      border-radius:18px;
      box-shadow: inset 0 1px 1px 0 rgba(255, 255, 255, 0.1);
    }
    .sidebar{grid-area:sidebar; padding:16px;display:flex;flex-direction:column;gap:12px}
    .topbar{grid-area:topbar; padding:14px 18px;display:flex;align-items:center;gap:12px}
    .main{grid-area:main; padding:18px;overflow:auto}
    .preview{
      grid-area:preview;
      background:rgba(11,13,16,0.5);
      padding:18px;padding-top:8px;position:sticky;top:16px;height:calc(100vh - 32px);
      transition: background-color 1s ease-in-out; /* For dynamic color morphing */
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;letter-spacing:.2px}
    .pill{padding:6px 10px;background:var(--chip);border-radius:999px;color:var(--muted);font-size:.8rem}
    .section-title{font-weight:800;font-size:1.1rem;margin:8px 0 6px 0;color:#e9edf2}
    .field{display:flex;flex-direction:column;margin:10px 0}
    .field label{font-size:.9rem;color:var(--muted);margin-bottom:8px}
    .row{display:flex;gap:12px;align-items:center}
    input[type="text"],input[type="date"],.fake-input{
      background:rgba(23, 26, 32, 0.8); border:1px solid var(--border);color:var(--text);
      padding:12px 12px;border-radius:12px;outline:none;width:100%; font-size: 1rem;
    }
    .btn{
      border:none;border-radius:12px;padding:12px 14px;font-weight:700; cursor:pointer;
      color:white;background:var(--accent); transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .btn:hover{background:var(--accent-2); transform: translateY(-2px);}
    .btn.secondary{background:#2b2f38;color:#dfe6ee}
    .btn.ghost{background:transparent;color:#cfe7d6;border:1px solid var(--accent)}
    .btn.danger{background:var(--danger)}
    .divider{height:1px;background:var(--border);margin:18px 0}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#1a1f27;border:1px solid var(--border);padding:4px 10px;border-radius:999px;color:#cfd6df;font-size:.82rem}
    .card{background:linear-gradient(180deg, rgba(20,24,33,0.8), rgba(16,20,27,0.8));border:1px solid var(--border);border-radius:18px;padding:16px;display:flex;flex-direction:column;gap:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .art{width:100%;aspect-ratio:1/1;background:#0f1217;border-radius:15px;display:grid;place-items:center;overflow:hidden}
    .art img{width:100%;height:100%;object-fit:cover}
    .song-title{font-size:1.25rem;font-weight:800}
    .muted{color:var(--muted)}
    .stack{display:flex;flex-direction:column;gap:4px}
    .custom-select{position:relative}
    .custom-select input{padding-right:36px}
    .custom-select .arrow{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;width:20px;height:20px;pointer-events:none;transition:transform .2s ease-in-out; display:grid; place-items:center; color: var(--muted)}
    .custom-select.open .arrow{transform:translateY(-50%) rotate(180deg)}
    .dropdown-panel{position:absolute;top:calc(100% + 4px);left:0;right:0;background:rgba(30,34,42,0.9); backdrop-filter:blur(5px); border:1px solid var(--border);border-radius:12px;z-index:100;max-height:250px; overflow-y:auto;opacity:0;visibility:hidden;transform:translateY(-10px); transition:opacity .2s ease,transform .2s ease,visibility .2s;}
    .dropdown-panel.open{opacity:1;visibility:visible;transform:translateY(0)}
    .dropdown-option{padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:.9rem}
    .dropdown-option:hover{background:var(--accent-2)}
    .dropdown-option img, .fake-input img {width:32px;height:32px;border-radius:4px;object-fit:cover}
    .file-input-wrapper{position:relative;overflow:hidden;display:inline-flex;align-items:center;gap:12px;}
    .file-input-wrapper input[type="file"]{position:absolute;left:0;top:0;opacity:0;cursor:pointer;width:100%;height:100%;}
    .file-input-label{display:inline-block;padding:10px 18px;cursor:pointer;border-radius:12px;background:#2b2f38;color:#dfe6ee;font-weight:600;font-size:0.9rem;}
    .file-name{font-size:0.9rem;color:var(--muted);}
    .main::-webkit-scrollbar{width:8px;} .main::-webkit-scrollbar-track{background:transparent;} .main::-webkit-scrollbar-thumb{background:#2b2f38;border-radius:4px;} .main::-webkit-scrollbar-thumb:hover{background:var(--accent-2);}
    
    /* --- NEW: Audio Player Styles --- */
    .audio-player{ margin-top: 10px; opacity: 0.5; pointer-events: none; transition: opacity 0.3s ease; }
    .audio-player.enabled{ opacity: 1; pointer-events: all; }
    .player-controls{ display: flex; align-items: center; gap: 15px; }
    #playPauseBtn{ font-size: 24px; background: none; border: none; color: var(--text); cursor: pointer; padding: 0;}
    .time-display{ font-size: 0.8rem; color: var(--muted); min-width: 45px; text-align: center; }
    #scrubber{ flex: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 5px; background: #333; border-radius: 5px; outline: none; cursor: pointer; }
    #scrubber::-webkit-slider-thumb{ -webkit-appearance: none; appearance: none; width: 15px; height: 15px; background: var(--accent); border-radius: 50%; cursor: pointer; }
    .volume-control{ position: relative; display: flex; align-items: center; }
    #volumeIcon{ font-size: 20px; cursor: pointer; }
    #volumeSlider{ position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%) rotate(-90deg); transform-origin: center center; background: rgba(30, 34, 42, 0.9); border: 1px solid var(--border); padding: 8px; border-radius: 8px;
                   width: 100px; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
    .volume-control:hover #volumeSlider{ opacity: 1; visibility: visible; }
    #volumeSlider input { width: 100%;}
    
    @media (max-width:1100px){
      .app{grid-template-columns:1fr;grid-template-rows:auto auto auto;grid-template-areas:"topbar" "main" "preview"}
      .preview{position:relative;height:auto} .sidebar{display:none}
    }
  </style>
</head>
<body>
  <!-- For liquid glass effect -->
  <svg style="display:none">
    <filter id="liquid-glass">
        <feTurbulence type="fractalNoise" baseFrequency="0.01 0.04" numOctaves="3" result="noise" />
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="10" />
    </filter>
  </svg>
  
  <div class="app">
    <aside class="sidebar"><div class="brand"><div>deepburn</div></div><div class="divider"></div><div class="pill">created by matthewmason</div><div class="pill">preset covers & albums by tootheh</div></aside>
    <header class="topbar"><div class="brand" style="gap:8px"><span class="pill">MP3</span><span class="muted">select an audio file and edit tags</span></div></header>
    <main class="main" id="main">
      <div class="section-title">upload files</div>
      <div class="field">
        <label>MP3 File</label>
        <div class="file-input-wrapper">
          <input type="file" id="mp3File" accept="audio/mpeg" />
          <label for="mp3File" class="file-input-label">Choose File</label>
          <span class="file-name" id="mp3FileName">No file chosen</span>
        </div>
      </div>
      <div class="field">
          <label>Album Cover</label>
          <div class="custom-select" id="coverSelect">
              <div class="fake-input" id="coverDisplay" style="cursor:pointer; padding-right:36px; display:flex; align-items:center; gap:10px">
                  <span class="muted">Select a preset or upload</span>
              </div>
              <div class="arrow">▼</div>
              <div class="dropdown-panel" id="coverDropdownPanel"></div>
          </div>
      </div>
      <div class="field">
          <label>... or Upload Custom Cover (JPG/PNG)</label>
          <div class="file-input-wrapper">
              <input type="file" id="coverFile" accept="image/*" />
              <label for="coverFile" class="file-input-label">Choose File</label>
              <span class="file-name" id="coverFileName">No file chosen</span>
          </div>
      </div>

      <div class="divider"></div>
      <div class="section-title">track info</div>
      <div class="row">
        <div class="field" style="flex:1"><label>Song Title *</label><input type="text" id="title" placeholder="Paranoid"/></div>
        <div class="field" style="flex:1">
          <label>Album Name</label>
          <div class="custom-select" id="albumSelect">
            <input type="text" id="album" placeholder="808s & Heartbreak" autocomplete="off"/>
            <div class="arrow">▼</div>
            <div class="dropdown-panel" id="albumDropdownPanel"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>Release Date</label><input type="date" id="releaseDate"/></div>
        <div class="field" style="flex:1">
          <label>Multiple Artists?</label>
          <div class="row"><input id="multiToggle" type="checkbox"/><span class="muted">Check to add 2+ artists</span></div>
        </div>
      </div>
      <div id="artistsArea">
        <div class="field artist-field">
          <label>Artist *</label>
          <div class="custom-select" id="artistSelect">
            <input type="text" class="artistInput" placeholder="Kanye West" autocomplete="off" />
            <div class="arrow">▼</div>
            <div class="dropdown-panel" id="artistDropdownPanel"><div class="dropdown-option">Kanye West</div></div>
          </div>
        </div>
      </div>
      <div class="row" id="addArtistRow" style="display:none;margin-top:8px">
        <button class="btn secondary" id="addArtistBtn" type="button">Add another artist</button>
        <button class="btn danger" id="clearArtistsBtn" type="button">Clear extra artists</button>
      </div>
      <div class="divider"></div>
      <div class="row">
        <button class="btn" id="downloadBtn" type="button">Download</button>
        <button class="btn ghost" id="resetBtn" type="button">Reset</button>
      </div>
      <p class="muted" style="margin-top:12px">note: all processing happens in your browser. large files may take a few seconds to tag.</p>
    </main>
    <aside class="preview" id="preview">
      <div class="section-title">Live Preview</div>
      <div class="card">
        <div class="art" id="artBox"><img src="nocover.png" alt="Album Cover" crossorigin="anonymous"/></div>
        <div class="stack">
          <div class="song-title" id="pTitle">Song Title</div>
          <div class="muted" id="pArtists">Artist</div>
          <div class="muted" id="pAlbum">Album • Year</div>
        </div>
        <!-- NEW: Audio player elements -->
        <div class="audio-player" id="audioPlayer">
          <div class="player-controls">
            <button id="playPauseBtn">►</button>
            <span class="time-display" id="currentTime">0:00</span>
            <input type="range" id="scrubber" value="0" min="0" max="100" step="0.1">
            <span class="time-display" id="duration">0:00</span>
            <div class="volume-control">
              <span id="volumeIcon">🔊</span>
              <div id="volumeSlider">
                <input type="range" id="volume" value="80" min="0" max="100">
              </div>
            </div>
          </div>
        </div>
        <div id="artistChipsWrapper">
          <div class="divider"></div>
          <div class="chips" id="artistChips"></div>
        </div>
      </div>
    </aside>
  </div>

<script>
const $ = (q) => document.querySelector(q);
const $$ = (q) => Array.from(document.querySelectorAll(q));

// DOM Elements
const mp3Input = $('#mp3File'), coverInput = $('#coverFile'), titleInput = $('#title'),
      albumInput = $('#album'), dateInput = $('#releaseDate'), multiToggle = $('#multiToggle'),
      artistsArea = $('#artistsArea'), addArtistRow = $('#addArtistRow'),
      addArtistBtn = $('#addArtistBtn'), clearArtistsBtn = $('#clearArtistsBtn'),
      artBox = $('#artBox'), pTitle = $('#pTitle'), pArtists = $('#pArtists'),
      pAlbum = $('#pAlbum'), artistChips = $('#artistChips');
      
// Audio Player Elements
const audioPlayer = $('#audioPlayer'), playPauseBtn = $('#playPauseBtn'),
      scrubber = $('#scrubber'), volume = $('#volume'),
      currentTimeEl = $('#currentTime'), durationEl = $('#duration');

// State
let coverArrayBuffer = null, currentCoverURL = null, audioURL = null;
let previewInterval = null, isCycling = true, userHasInteracted = false;
let audio = new Audio();

// --- Main Functions ---
async function imageURLToBuffer(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return await response.arrayBuffer();
    } catch (error) {
        console.error(`Failed to fetch image '${url}':`, error);
        return null;
    }
}

function getID3Ctor() {
    const g = window.ID3Writer; if (!g) throw new Error('ID3Writer not loaded.');
    if (typeof g === 'function') return g; if (g?.ID3Writer) return g.ID3Writer; if (g?.default) return g.default;
    throw new Error('ID3Writer constructor not found.');
}

const rawAlbumList = ["before college dropout", "the college dropout", "late registration", "graduation", "808's & Heartbreak", "good ass job", "my beautiful dark twisted fantasy", "watch the throne", "cruel summer", "yeezus", "cruel winter", "yeezus 2", "so help me god", "SWISH", "the life of pablo", "cruel winter [V2]", "turbografx16", "LOVE EVERYONE", "DAYTONA", "ye", "KIDS SEE GHOSTS", "NASIR", "K.T.S.E.", "Good Ass Job (2018)", "Yandhi", "JESUS IS KING", "DONDA", "DONDA 2", "WAR", "VULTURES 1", "BULLY", "CUCK", "IN A PERFECT WORLD"];
const allCaps = ["SWISH", "LOVE EVERYONE", "DAYTONA", "NASIR", "KIDS SEE GHOSTS", "K.T.S.E.", "JESUS IS KING", "DONDA", "DONDA 2", "WAR", "VULTURES 1", "BULLY", "CUCK", "IN A PERFECT WORLD"];
const allLower = ["ye"];
const albumsToExcludeFromCovers = ["before college dropout", "cruel winter [V2]", "Good Ass Job (2018)"];

function formatAlbumName(name) {
    const upperName = name.toUpperCase();
    if (allCaps.includes(upperName)) return upperName;
    if (allLower.includes(name.toLowerCase())) return name.toLowerCase();
    return name.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}
const formattedAlbumList = rawAlbumList.map(formatAlbumName);
const albumCoverList = formattedAlbumList.filter(name => !albumsToExcludeFromCovers.map(formatAlbumName).includes(name));
const sanitizeForFilename = (text) => text.replace(/'/g, '').replace(/&/g, 'and').replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '').toLowerCase();

// --- UPDATED Tracklist ---
const randomPreviewTracks = [
    { title: "Power", album: "My Beautiful Dark Twisted Fantasy", artists: ["Kanye West", "Dwele"] },
    { title: "Famous", album: "The Life Of Pablo", artists: ["Kanye West", "Rihanna", "Swizz Beatz"] },
    { title: "Heartless", album: "808's & Heartbreak", artists: ["Kanye West"] },
    { title: "Alien", album: "Yandhi", artists: ["Kanye West", "Kid Cudi", "Young Thug"] },
    { title: "City in the Sky", album: "Yandhi", artists: ["Kanye West", "Ty Dolla $ign", "070 Shake"] },
    { title: "Simulation Baptize", album: "CUCK", artists: ["Kanye West", "A$AP Rocky", "Pardison Fontaine"]},
    { title: "Future Sounds", album: "DONDA", artists: ["Kanye West", "Travis Scott", "Victory Boyd"] },
    { title: "Mission Control", album: "IN A PERFECT WORLD", artists: ["Kanye West", "Tony Williams"] },
    { title: "Reborn", album: "KIDS SEE GHOSTS", artists: ["KIDS SEE GHOSTS"] },
    { title: "Follow God", album: "JESUS IS KING", artists: ["Kanye West"]},
];

function setupCustomSelect(containerId) { /* ... same as before ... */ }
function closeAllDropdowns() { /* ... same as before ... */ }
document.addEventListener('click', (e) => { /* ... same as before ... */ });

function populateDropdowns() { /* ... same as before, no changes needed ... */ }

// --- State Control ---
function stopCycling() {
    if (!userHasInteracted) {
        userHasInteracted = true;
        clearInterval(previewInterval);
        isCycling = false;
    }
}
function startCycling() { /* ... same as before ... */ }
async function stopCyclingAndUpdate(action) { /* ... same as before ... */ }


// --- UI Update & Preview Logic ---
function updateDynamicBackgroundColor(imageUrl) {
    const img = new Image();
    img.src = imageUrl;
    img.crossOrigin = "Anonymous"; // Important for Vibrant.js
    img.onload = () => {
        Vibrant.from(img).getPalette((err, palette) => {
            if (!err && palette && palette.DarkMuted) {
                const [r,g,b] = palette.DarkMuted.rgb;
                $('#preview').style.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.5)`;
            } else {
                 $('#preview').style.backgroundColor = 'rgba(11,13,16,0.5)';
            }
        });
    };
    img.onerror = () => { $('#preview').style.backgroundColor = 'rgba(11,13,16,0.5)'; }
}

async function handlePresetCoverSelection(albumName) {
    if (coverInput.files.length > 0) return;
    const filename = `${sanitizeForFilename(albumName)}.png`;
    const artImgHTML = `<img src="${filename}" alt="${albumName}" crossorigin="anonymous" onerror="this.src='nocover.png';">`;
    artBox.innerHTML = artImgHTML;
    updateDynamicBackgroundColor(filename);
    
    if (currentCoverURL) { URL.revokeObjectURL(currentCoverURL); currentCoverURL = null; }
    coverArrayBuffer = await imageURLToBuffer(filename);
    coverInput.value = '';
    $('#coverFileName').textContent = 'No file chosen';
}

function updatePreview() { /* ... same as before, no changes needed ... */ }

function setRandomPreview() {
    if (userHasInteracted) return;
    const track = randomPreviewTracks[Math.floor(Math.random() * randomPreviewTracks.length)];
    titleInput.placeholder = track.title;
    albumInput.placeholder = track.album;
    $('.artistInput').placeholder = track.artists[0];

    if (coverInput.files.length === 0 && !coverArrayBuffer) {
        const coverFilename = sanitizeForFilename(track.album) + '.png';
        const artImgHTML = `<img src="${coverFilename}" alt="${track.album}" crossorigin="anonymous" onerror="this.src='nocover.png'">`;
        artBox.innerHTML = artImgHTML;
        updateDynamicBackgroundColor(coverFilename);
    }
    pArtists.textContent = track.artists.join(', ');
    updatePreview();
}

// --- Event Listeners ---
mp3Input.addEventListener('change', () => {
    stopCyclingAndUpdate(() => {
        const file = mp3Input.files?.[0];
        $('#mp3FileName').textContent = file ? file.name : 'No file chosen';
        if (file) {
            if(audioURL) URL.revokeObjectURL(audioURL);
            audioURL = URL.createObjectURL(file);
            audio.src = audioURL;
            audioPlayer.classList.add('enabled');
            if (!titleInput.value) {
                titleInput.value = file.name.replace(/\.[^.]+$/, '');
            }
        } else {
             audioPlayer.classList.remove('enabled');
        }
    });
});

coverInput.addEventListener('change', async () => { /* ... mostly same ... */ });
// Other listeners...

// --- Audio Player Logic ---
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
}

audio.addEventListener('loadedmetadata', () => {
    durationEl.textContent = formatTime(audio.duration);
    scrubber.max = audio.duration;
});

audio.addEventListener('timeupdate', () => {
    scrubber.value = audio.currentTime;
    currentTimeEl.textContent = formatTime(audio.currentTime);
});

audio.addEventListener('ended', () => {
    playPauseBtn.textContent = '►';
    scrubber.value = 0;
    currentTimeEl.textContent = '0:00';
});

playPauseBtn.addEventListener('click', () => {
    if (audio.paused) {
        audio.play();
        playPauseBtn.textContent = '❚❚';
    } else {
        audio.pause();
        playPauseBtn.textContent = '►';
    }
});

scrubber.addEventListener('input', () => {
    audio.currentTime = scrubber.value;
});

volume.addEventListener('input', () => {
    audio.volume = volume.value / 100;
});

// --- Initialization ---
populateDropdowns();
setupCustomSelect('#albumSelect');
setupCustomSelect('#artistSelect');
setupCustomSelect('#coverSelect');
setRandomPreview();
previewInterval = setInterval(setRandomPreview, 5000);
</script>
</body>
</html>
