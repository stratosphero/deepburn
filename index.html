<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Spotify Local Files | Deepburn</title>
  <link rel="icon" type="image/png" href="logo.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="./browser-id3-writer.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f1116; --panel:#121418; --panel-2:#0b0d10; --muted:#a8b0bb;
      --text:#e8ebef; --accent:#3e437c; --accent-2:#4e7290; --border:#1f232b;
      --chip:#22262e; --danger:#e34d4d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#101319 0%, #0b0e13 100%);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
    }
    .app{
      display:grid; grid-template-columns:260px 1fr 420px; grid-template-rows:64px 1fr;
      grid-template-areas:"sidebar topbar preview" "sidebar main   preview";
      min-height:100vh; gap:16px; padding:16px;
    }
    .sidebar{grid-area:sidebar;background:var(--panel);border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:12px}
    .topbar{grid-area:topbar;background:var(--panel);border-radius:16px;padding:14px 18px;display:flex;align-items:center;gap:12px}
    .main{grid-area:main;background:var(--panel);border-radius:16px;padding:18px;overflow:auto}
    .preview{grid-area:preview;background:var(--panel-2);border:1px solid var(--border);border-radius:16px;padding:18px;padding-top:8px;position:sticky;top:16px;height:calc(100vh - 32px);}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;letter-spacing:.2px}
    .pill{padding:6px 10px;background:var(--chip);border-radius:999px;color:var(--muted);font-size:.8rem}
    .section-title{font-weight:800;font-size:1.1rem;margin:8px 0 6px 0;color:#e9edf2}
    .field{display:flex;flex-direction:column;margin:10px 0}
    .field label{font-size:.9rem;color:var(--muted);margin-bottom:8px}
    .row{display:flex;gap:12px;align-items:center}
    input[type="text"],input[type="date"],input[type="file"],.fake-input{
      background:#171a20;border:1px solid var(--border);color:var(--text);
      padding:12px 12px;border-radius:12px;outline:none;width:100%;
    }
    input[type="file"]{padding:10px;flex:1}
    .btn{border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer;color:white;background:var(--accent)}
    .btn:hover{background:var(--accent-2)}
    .btn.secondary{background:#2b2f38;color:#dfe6ee}
    .btn.ghost{background:transparent;color:#cfe7d6;border:1px solid var(--accent)}
    .btn.danger{background:var(--danger)}
    .divider{height:1px;background:var(--border);margin:18px 0}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#1a1f27;border:1px solid var(--border);padding:4px 10px;border-radius:999px;color:#cfd6df;font-size:.82rem}
    .card{background:linear-gradient(180deg,#141821 0,#10141b 100%);border:1px solid var(--border);border-radius:18px;padding:16px;display:flex;flex-direction:column;gap:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .art{width:100%;aspect-ratio:1/1;background:#0f1217;border-radius:15px;display:grid;place-items:center;overflow:hidden}
    .art img{width:100%;height:100%;object-fit:cover}
    .song-title{font-size:1.25rem;font-weight:800}
    .muted{color:var(--muted)}
    .stack{display:flex;flex-direction:column;gap:4px}
    .custom-select{position:relative}
    .custom-select input{padding-right:36px}
    .custom-select .arrow{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;width:20px;height:20px;pointer-events:none;transition:transform .2s ease-in-out; display:grid; place-items:center; color: var(--muted)}
    .custom-select.open .arrow{transform:translateY(-50%) rotate(180deg)}
    .dropdown-panel{
      position:absolute;top:calc(100% + 4px);left:0;right:0;background:#1e222a;
      border:1px solid var(--border);border-radius:12px;z-index:100;max-height:250px;
      overflow-y:auto;opacity:0;visibility:hidden;transform:translateY(-10px);
      transition:opacity .2s ease,transform .2s ease,visibility .2s;
    }
    .dropdown-panel.open{opacity:1;visibility:visible;transform:translateY(0)}
    .dropdown-option{padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:.9rem}
    .dropdown-option:hover{background:var(--accent-2)}
    .dropdown-option img, .fake-input img {width:32px;height:32px;border-radius:4px;object-fit:cover}

    @media (max-width:1100px){
      .app{grid-template-columns:1fr;grid-template-rows:auto auto auto;grid-template-areas:"topbar" "main" "preview"}
      .preview{position:relative;height:auto} .sidebar{display:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar"><div class="brand"><div>deepburn</div></div><div class="divider"></div><div class="pill">created by matthewmason</div></aside>
    <header class="topbar"><div class="brand" style="gap:8px"><span class="pill">MP3</span><span class="muted">select an audio file and edit tags</span></div></header>
    <main class="main" id="main">
      <div class="section-title">upload files</div>
      <div class="field">
        <label>MP3 File</label><input type="file" id="mp3File" accept="audio/mpeg" />
      </div>
      <div class="field">
          <label>Album Cover</label>
          <div class="custom-select" id="coverSelect">
              <div class="fake-input" id="coverDisplay" style="cursor:pointer; padding-right:36px; display:flex; align-items:center; gap:10px">
                  <span class="muted">Select a preset or upload</span>
              </div>
              <div class="arrow">▼</div>
              <div class="dropdown-panel" id="coverDropdownPanel"></div>
          </div>
      </div>
      <div class="field">
          <label>... or Upload Custom Cover (JPG/PNG)</label>
          <input type="file" id="coverFile" accept="image/*" />
      </div>

      <div class="divider"></div>
      <div class="section-title">track info</div>
      <div class="row">
        <div class="field" style="flex:1"><label>Song Title *</label><input type="text" id="title" placeholder="Paranoid"/></div>
        <div class="field" style="flex:1">
          <label>Album Name</label>
          <div class="custom-select" id="albumSelect">
            <input type="text" id="album" placeholder="808s & Heartbreak" autocomplete="off"/>
            <div class="arrow">▼</div>
            <div class="dropdown-panel" id="albumDropdownPanel"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>Release Date</label><input type="date" id="releaseDate"/></div>
        <div class="field" style="flex:1">
          <label>Multiple Artists?</label>
          <div class="row"><input id="multiToggle" type="checkbox"/><span class="muted">Check to add 2+ artists</span></div>
        </div>
      </div>
      <div id="artistsArea">
        <div class="field artist-field">
          <label>Artist *</label>
          <div class="custom-select" id="artistSelect">
            <input type="text" class="artistInput" placeholder="Kanye West" autocomplete="off" />
            <div class="arrow">▼</div>
            <div class="dropdown-panel" id="artistDropdownPanel"><div class="dropdown-option">Kanye West</div></div>
          </div>
        </div>
      </div>
      <div class="row" id="addArtistRow" style="display:none;margin-top:8px">
        <button class="btn secondary" id="addArtistBtn" type="button">Add another artist</button>
        <button class="btn danger" id="clearArtistsBtn" type="button">Clear extra artists</button>
      </div>
      <div class="divider"></div>
      <div class="row">
        <button class="btn" id="downloadBtn" type="button">Download</button>
        <button class="btn ghost" id="resetBtn" type="button">Reset</button>
      </div>
      <p class="muted" style="margin-top:12px">note: all processing happens in your browser. large files may take a few seconds to tag.</p>
    </main>
    <aside class="preview" id="preview">
      <div class="section-title">Live Preview</div>
      <div class="card">
        <div class="art" id="artBox"><img src="nocover.png" alt="Album Cover"/></div>
        <div class="stack">
          <div class="song-title" id="pTitle">Song Title</div>
          <div class="muted" id="pArtists">Artist</div>
          <div class="muted" id="pAlbum">Album • Year</div>
        </div>
        <div class="divider"></div>
        <div class="chips" id="artistChips"></div>
      </div>
    </aside>
  </div>

<script>
const $ = (q) => document.querySelector(q);
const $$ = (q) => Array.from(document.querySelectorAll(q));

const mp3Input = $('#mp3File'), coverInput = $('#coverFile'), titleInput = $('#title'),
      albumInput = $('#album'), dateInput = $('#releaseDate'), multiToggle = $('#multiToggle'),
      artistsArea = $('#artistsArea'), addArtistRow = $('#addArtistRow'),
      addArtistBtn = $('#addArtistBtn'), clearArtistsBtn = $('#clearArtistsBtn'),
      artBox = $('#artBox'), pTitle = $('#pTitle'), pArtists = $('#pArtists'),
      pAlbum = $('#pAlbum'), artistChips = $('#artistChips');

let coverArrayBuffer = null, currentCoverURL = null,
    previewInterval = null, isCycling = true;

// --- FIX #1: Added a flag to permanently stop the preview cycle after the first user interaction.
let userHasInteracted = false;

// --- IMPORTANT ACTION REQUIRED FOR PRESET COVERS ---
// To make preset covers embeddable in the MP3, you must convert each cover image to a Base64 string.
// 1. Go to a site like "base64-image.de".
// 2. Upload one of your cover PNG files.
// 3. Copy the generated string (it will start with "data:image/png;base64,...").
// 4. Paste it into this object. The key should be the sanitized album name (like your filenames).
const presetCoverData = {
    "graduation": "PASTE_GRADUATION_BASE64_STRING_HERE",
    "808sheartbreak": "PASTE_808S_&_HEARTBREAK_BASE64_STRING_HERE",
    "mybeautifuldarktwistedfantasy": "PASTE_MBDTF_BASE64_STRING_HERE"
    // Add all your other album covers here. Example:
    // "yeezus": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
};

function getID3Ctor() {
    const g = window.ID3Writer; if (!g) throw new Error('ID3Writer not loaded.');
    if (typeof g === 'function') return g; if (g?.ID3Writer) return g.ID3Writer; if (g?.default) return g.default;
    throw new Error('ID3Writer constructor not found.');
}

// --- FIX #2: New helper function to convert a Base64 data string into a buffer for tagging.
function base64ToBuffer(base64) {
    if (!base64 || !base64.startsWith('data:image')) return null;
    const binaryString = window.atob(base64.split(',')[1]);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

const rawAlbumList = ["before college dropout", "the college dropout", "late registration", "graduation", "808's & Heartbreak", "good ass job", "my beautiful dark twisted fantasy", "watch the throne", "cruel summer", "yeezus", "cruel winter", "yeezus 2", "so help me god", "SWISH", "the life of pablo", "cruel winter [V2]", "turbografx16", "LOVE EVERYONE", "DAYTONA", "ye", "KIDS SEE GHOSTS", "Nasir", "K.T.S.E.", "Good Ass Job (2018)", "Yandhi [V1]", "Yandhi [V2]", "JESUS IS KING", "JESUS IS LORD", "JESUS IS KING: The Dr. Dre Version", "DONDA [V1]", "DONDA [V2]", "DONDA [V3]", "DONDA 2", "WAR", "YEBU", "Bad Bitch Playbook", "VULTURES 1", "VULTURES 2", "VULTURES 3", "BULLY", "CUCK", "IN A PERFECT WORLD"];
const allCaps = ["SWISH", "LOVE EVERYONE", "DAYTONA", "KIDS SEE GHOSTS", "K.T.S.E.", "JESUS IS KING", "DONDA [V1]", "DONDA [V2]", "DONDA [V3]", "DONDA 2", "WAR", "YEBU", "VULTURES 1", "VULTURES 2", "VULTURES 3", "BULLY", "CUCK", "IN A PERFECT WORLD"];
const allLower = ["ye"];
const albumsToExcludeFromCovers = ["before college dropout", "cruel winter [V2]", "Good Ass Job (2018)", "Yandhi [V2]"];

function formatAlbumName(name) {
    const upperName = name.toUpperCase();
    if (allCaps.includes(upperName)) return upperName;
    if (allLower.includes(name.toLowerCase())) return name.toLowerCase();
    if (upperName.startsWith("JESUS IS KING:")) return "JESUS IS KING" + name.substring(13);
    return name.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}
const formattedAlbumList = rawAlbumList.map(formatAlbumName);
const albumCoverList = formattedAlbumList.filter(name => !albumsToExcludeFromCovers.map(formatAlbumName).includes(name));
const sanitizeForFilename = (text) => text.replace(/'/g, '').replace(/&/g, 'and').replace(/[^a-zA-Z0-9]/g, '').toLowerCase();

const randomPreviewTracks = [
    { title: "Power", album: "My Beautiful Dark Twisted Fantasy", artists: ["Kanye West", "Dwele"] },
    { title: "Heard 'Em Say", album: "Late Registration", artists: ["Kanye West", "Adam Levine"] },
    { title: "Stronger", album: "Graduation", artists: ["Kanye West"] },
    { title: "Heartless", album: "808's & Heartbreak", artists: ["Kanye West"] },
    { title: "Famous", album: "The Life Of Pablo", artists: ["Kanye West", "Rihanna", "Swizz Beatz"] },
    { title: "Reborn", album: "KIDS SEE GHOSTS", artists: ["KIDS SEE GHOSTS"] }
];

function setupCustomSelect(containerId) {
    const container = $(containerId), trigger = container.querySelector('input, .fake-input'), panel = container.querySelector('.dropdown-panel');
    trigger.addEventListener('click', () => { const isOpen = container.classList.contains('open'); closeAllDropdowns(); if (!isOpen) { container.classList.add('open'); panel.classList.add('open'); } });
}
function closeAllDropdowns() { $$('.custom-select.open').forEach(sel => sel.classList.remove('open')); $$('.dropdown-panel.open').forEach(p => p.classList.remove('open')); }
document.addEventListener('click', (e) => { if (!e.target.closest('.custom-select')) closeAllDropdowns(); });

function populateDropdowns() {
    const albumPanel = $('#albumDropdownPanel'), coverPanel = $('#coverDropdownPanel');
    albumPanel.innerHTML = ''; coverPanel.innerHTML = '';
    formattedAlbumList.forEach(albumName => {
        const opt = document.createElement('div'); opt.className = 'dropdown-option'; opt.textContent = albumName;
        opt.addEventListener('click', () => { stopCyclingAndUpdate(() => { albumInput.value = albumName; handlePresetCoverSelection(albumName); }); });
        albumPanel.appendChild(opt);
    });
    albumCoverList.forEach(albumName => {
        const cleanName = sanitizeForFilename(albumName);
        const opt = document.createElement('div');
        opt.className = 'dropdown-option';
        opt.innerHTML = `<img src="${cleanName}.png" alt="${albumName} cover"><span>${albumName}</span>`;
        opt.addEventListener('click', () => {
            stopCyclingAndUpdate(() => {
                $('#coverDisplay').innerHTML = `<img src="${cleanName}.png" alt="${albumName} cover"><span>${albumName}</span>`;
                albumInput.value = albumName;
                handlePresetCoverSelection(albumName);
            });
        });
        coverPanel.appendChild(opt);
    });
    $('#artistDropdownPanel .dropdown-option').addEventListener('click', () => { stopCyclingAndUpdate(() => { $('.artistInput').value = 'Kanye West'; }); });
}

// --- FIX #1: stopCycling function now sets the permanent interaction flag.
function stopCycling() {
    if (!userHasInteracted) {
        userHasInteracted = true;
        clearInterval(previewInterval);
        isCycling = false;
    }
}
function startCycling() {
    userHasInteracted = false;
    if (!isCycling) {
        previewInterval = setInterval(setRandomPreview, 5000);
        isCycling = true;
    }
}
// This function now runs the user's action *after* stopping the cycle.
function stopCyclingAndUpdate(action) {
    stopCycling();
    if (action && typeof action === 'function') {
        action();
    }
    updatePreview();
}

// --- FIX #2: Updated function to use the Base64 data object.
function handlePresetCoverSelection(albumName) {
    if (coverInput.files.length > 0) return;
    const cleanName = sanitizeForFilename(albumName);
    const base64Data = presetCoverData[cleanName];

    if (base64Data && base64Data.startsWith('data:image')) {
        artBox.innerHTML = `<img src="${base64Data}" alt="${albumName}">`;
        coverArrayBuffer = base64ToBuffer(base64Data);
    } else {
        // Fallback for display only if Base64 data isn't provided for this album.
        const fallbackFilename = `${cleanName}.png`;
        artBox.innerHTML = `<img src="${fallbackFilename}" alt="${albumName}" onerror="this.src='nocover.png';">`;
        coverArrayBuffer = null; // IMPORTANT: No data means no cover will be embedded.
        console.warn(`Base64 data for "${albumName}" not found in presetCoverData. It will not be embedded.`);
    }

    if(currentCoverURL) { URL.revokeObjectURL(currentCoverURL); currentCoverURL = null; }
    coverInput.value = '';
}


function updatePreview() {
    const title = titleInput.value.trim() || titleInput.placeholder;
    const album = albumInput.value.trim() || albumInput.placeholder;
    const year = dateInput.value ? new Date(dateInput.value).getFullYear().toString() : '';
    let artists = $$('.artistInput').map(i => i.value.trim()).filter(Boolean);
    // Don't use cycling preview's artists if the user has started editing.
    if (!userHasInteracted && artists.length === 0 && $$('.artistInput')[0].placeholder === 'Kanye West') {
        artists = pArtists.textContent.split(', ');
    }
    const displayArtists = artists.length ? artists : ['Artist'];
    pTitle.textContent = title;
    pArtists.textContent = displayArtists.join(', ');
    pAlbum.textContent = album + (year ? ` • ${year}` : '');
    artistChips.innerHTML = displayArtists.map(a => `<div class="chip">${a}</div>`).join('');
}

function setRandomPreview() {
    // --- FIX #1: Cycle stops immediately if this flag is set.
    if (userHasInteracted) return;
    const track = randomPreviewTracks[Math.floor(Math.random() * randomPreviewTracks.length)];
    titleInput.placeholder = track.title;
    albumInput.placeholder = track.album;
    $('.artistInput').placeholder = track.artists[0];
    if (coverInput.files.length === 0 && !coverArrayBuffer) {
        const coverFilename = sanitizeForFilename(track.album) + '.png';
        artBox.innerHTML = `<img src="${coverFilename}" alt="${track.album}" onerror="this.src='nocover.png'">`;
    }
    pArtists.textContent = track.artists.join(', ');
    updatePreview();
}

// --- FIX #1: All event listeners now call stopCyclingAndUpdate.
[titleInput, dateInput, albumInput].forEach(el => el.addEventListener('input', () => stopCyclingAndUpdate()));
artistsArea.addEventListener('input', e => { if (e.target.classList.contains('artistInput')) stopCyclingAndUpdate(); });
mp3Input.addEventListener('change', () => { stopCyclingAndUpdate(() => { const f = mp3Input.files?.[0]; if (!f) return; if (!titleInput.value) titleInput.value = f.name.replace(/\.[^.]+$/, ''); }); });
coverInput.addEventListener('change', () => {
    stopCyclingAndUpdate(async () => {
        const file = coverInput.files?.[0]; if (!file) { coverArrayBuffer = null; return; }
        coverArrayBuffer = await file.arrayBuffer();
        if (currentCoverURL) URL.revokeObjectURL(currentCoverURL);
        currentCoverURL = URL.createObjectURL(file);
        artBox.innerHTML = `<img src="${currentCoverURL}" alt="Custom Cover">`;
        $('#coverDisplay').innerHTML = `<span>${file.name}</span>`;
    });
});

multiToggle.addEventListener('change', () => { stopCyclingAndUpdate(() => { if (multiToggle.checked) { addArtistRow.style.display = 'flex'; if ($$('.artistInput').length === 1) addArtist(); } else { $$('.artist-field').slice(1).forEach(n => n.remove()); addArtistRow.style.display = 'none'; } }); });
addArtistBtn?.addEventListener('click', () => { stopCyclingAndUpdate(() => addArtist()); });
clearArtistsBtn?.addEventListener('click', () => { stopCyclingAndUpdate(() => $$('.artist-field').slice(1).forEach(n => n.remove())); });
function addArtist() { const wrap = document.createElement('div'); wrap.className = 'field artist-field'; wrap.innerHTML = `<label>Artist</label><input type="text" class="artistInput" placeholder="Feature / Producer" />`; artistsArea.appendChild(wrap); }

document.getElementById('downloadBtn').addEventListener('click', async () => {
    stopCycling(); // Ensure we are stopped before download
    const mp3 = mp3Input.files?.[0]; if (!mp3) return alert('Please choose an MP3 file first.');
    const title = titleInput.value.trim(); if (!title) return alert('Please enter a Song Title.');
    let artists = $$('.artistInput').map(i=>i.value.trim()).filter(Boolean); if (!artists.length) { artists = ['Unknown Artist']; }
    try {
        const ID3 = getID3Ctor(); const mp3Buffer = await mp3.arrayBuffer(); const writer = new ID3(mp3Buffer);
        const album = albumInput.value.trim();
        const year = dateInput.value ? new Date(dateInput.value).getFullYear().toString() : null;
        writer.setFrame('TIT2', title).setFrame('TPE1', artists);
        if (album) writer.setFrame('TALB', album);
        if (year) { try { writer.setFrame('TDRC', year); } catch(_) {} try { writer.setFrame('TYER', year); } catch(_) {} }
        if (coverArrayBuffer) { const mime = coverInput.files?.[0]?.type || 'image/png'; writer.setFrame('APIC', { type: 3, data: new Uint8Array(coverArrayBuffer), description: 'Cover', mime }); }
        writer.addTag(); const url = URL.createObjectURL(writer.getBlob()), a = document.createElement('a'); a.href = url;
        const safe = (s) => s.replace(/[\/:*?"<>|]+/g, '').trim(); a.download = `${safe(artists.join(', '))} - ${safe(title)}.mp3`;
        a.click(); URL.revokeObjectURL(url);
    } catch(err) { console.error('Tagging/Download failed:', err); alert(`Something went wrong: ${err?.message || err}`); }
});

document.getElementById('resetBtn').addEventListener('click', () => {
    [titleInput, albumInput, dateInput].forEach(el => { el.value = ''; });
    mp3Input.value=''; coverInput.value=''; coverArrayBuffer=null; if(currentCoverURL) { URL.revokeObjectURL(currentCoverURL); currentCoverURL=null; }
    $('#coverDisplay').innerHTML = '<span class="muted">Select a preset or upload</span>';
    $$('.artist-field').slice(1).forEach(n=>n.remove()); $$('.artistInput')[0].value=''; $('.artistInput').placeholder = 'Kanye West';
    artBox.innerHTML = '<img src="nocover.png" alt="Album Cover"/>';
    pArtists.textContent = 'Artist'; pTitle.textContent="Song Title"; pAlbum.textContent="Album • Year";
    artistChips.innerHTML = `<div class="chip">Artist</div>`;
    // Restart the cycle
    startCycling();
    setRandomPreview();
});

populateDropdowns();
setupCustomSelect('#albumSelect'); setupCustomSelect('#artistSelect'); setupCustomSelect('#coverSelect');
setRandomPreview(); // Initial preview
previewInterval = setInterval(setRandomPreview, 5000); // Start cycle
</script>
</body>
</html>